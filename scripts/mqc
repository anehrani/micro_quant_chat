#!/bin/bash
# Micro Quant Chat - Command Helper
# Makes it easy to run common commands

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Get the project root (parent of scripts/)
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Export PYTHONPATH to include project root
export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"

# Change to project root directory
cd "$PROJECT_ROOT"

PYTHON=".venv/bin/python"

print_usage() {
    cat << EOF
Micro Quant Chat - GPT for Financial Time Series

Usage: $0 <command> [options]

Commands:
  examples           Run usage examples
    train             Train the model (Stage 1 pretrain)
    stage1            Stage 1 pretrain (alias of train)
    stage2            Stage 2 supervised fine-tune (BTC)
    stage3            Stage 3 RL fine-tune (BTC, REINFORCE)
  eval              Evaluate trained model
  generate          Generate price predictions
  analyze           Analyze token data
  help              Show this help message

Training Options:
  --epochs N        Number of training epochs (default: 10)
  --batch N         Batch size (default: 32)
  --lr RATE         Learning rate (default: 5e-4)

Generation Options:
  --seed "TOKENS"   Seed tokens (default: "80 81 83 89 66")
  --num N           Number of tokens to generate (default: 50)
  --temp T          Temperature (default: 0.8)
  --samples N       Number of samples (default: 3)

Examples:
  $0 examples
  $0 train --epochs 20 --batch 64
  $0 generate --seed "80 81 83" --num 100
  $0 eval
  $0 analyze --patterns

EOF
}

case "$1" in
    examples)
        echo "Running usage examples..."
        $PYTHON src/examples.py
        ;;
    
    train)
        shift
        echo "Training model..."
        $PYTHON scripts/base_train.py "$@"
        ;;

    stage1|pretrain)
        shift
        echo "Stage 1 (pretrain)..."
        $PYTHON scripts/stage1_pretrain.py "$@"
        ;;

    stage2|sft)
        shift
        echo "Stage 2 (SFT BTC)..."
        $PYTHON scripts/stage2_sft.py "$@"
        ;;

    stage3|rl)
        shift
        echo "Stage 3 (RL BTC)..."
        $PYTHON scripts/stage3_rl.py "$@"
        ;;
    
    eval|evaluate)
        shift
        echo "Evaluating model..."
        $PYTHON scripts/base_eval.py "$@"
        ;;
    
    generate|gen)
        shift
        echo "Generating predictions..."
        $PYTHON scripts/base_sample.py "$@"
        ;;
    
    analyze|analysis)
        shift
        echo "Analyzing tokens..."
        $PYTHON src/token_analysis.py "$@"
        ;;
    
    help|--help|-h)
        print_usage
        ;;
    
    *)
        if [ -z "$1" ]; then
            print_usage
        else
            echo "Unknown command: $1"
            echo "Run '$0 help' for usage information"
            exit 1
        fi
        ;;
esac
